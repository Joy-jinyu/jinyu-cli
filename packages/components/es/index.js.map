{"version":3,"file":"index.js","sources":["../src/upload-gallery/input-link-modal.tsx","../src/upload-gallery/index.tsx"],"sourcesContent":["import { Form, Image, Input, Modal } from 'antd'\nimport React, { useState, useCallback } from 'react'\n\ninterface IInputLinkModal {\n  visible: boolean\n  onClose: () => void\n  onSave: (link: string) => void\n}\n\nconst LEGAL_HTTP_SOURCE_REGULAR = /^(?:http(s)?:\\/\\/)(\\S)*(\\.)+/\n\nexport const InputLinkModal = ({ visible, onClose, onSave }: IInputLinkModal) => {\n  const [form] = Form.useForm()\n  const [imageLink, setImageLink] = useState('')\n\n  const imageChange = (e: any) => {\n    setImageLink(e.target.value)\n  }\n\n  const handleOk = useCallback(async () => {\n    const values = await form.validateFields()\n    onSave(values.link)\n    form.resetFields()\n    setImageLink('')\n  }, [])\n\n  const handleCancel = () => {\n    onClose()\n  }\n\n  return (\n    <Modal\n      open={visible}\n      visible={visible}\n      title=\"图片地址\"\n      onOk={handleOk}\n      onCancel={handleCancel}\n    >\n      <Form form={form} name=\"name\">\n        <Form.Item\n          label=\"图片链接\"\n          name=\"link\"\n          rules={[\n            { required: true, message: '请输入图片链接' },\n            () => ({\n              validator(_, value) {\n                if (!!value && !LEGAL_HTTP_SOURCE_REGULAR.test(value as string)) {\n                  return Promise.reject(\n                    new Error('请输入填写正确的地址，例：https://www.baidu.com')\n                  )\n                }\n                return Promise.resolve()\n              }\n            })\n          ]}\n          validateFirst={true}\n        >\n          <Input allowClear placeholder=\"图片链接\" onChange={imageChange} />\n        </Form.Item>\n        {imageLink && LEGAL_HTTP_SOURCE_REGULAR.test(imageLink) && (\n          <Form.Item>\n            <Image height={100} src={imageLink} />\n          </Form.Item>\n        )}\n      </Form>\n    </Modal>\n  )\n}\n","import { PlusOutlined } from '@ant-design/icons'\nimport { Modal, Upload } from 'antd'\nimport type { RcFile } from 'antd/es/upload'\nimport type { UploadFile } from 'antd/es/upload/interface'\nimport mockjs from 'mockjs'\nimport { useCallbackRef } from '@ovometajs/hooks'\nimport React, { useState, useEffect } from 'react'\nimport { DragDropContext, Draggable, Droppable, DropResult } from 'react-beautiful-dnd'\nimport { InputLinkModal } from './input-link-modal'\nimport './styles.less'\n\ninterface IUploadGallery {\n  action: string\n  value?: string\n  onChange?: (value: UploadFile[]) => void\n  multiple?: boolean\n  max?: number\n}\n\nexport const UploadGallery = ({ action, value, onChange, multiple, max = 1 }: IUploadGallery) => {\n  const [inputLinkOpen, setInputLinkOpen] = useState(false)\n  const [previewOpen, setPreviewOpen] = useState(false)\n  const [previewImage, setPreviewImage] = useState('')\n  const [previewTitle, setPreviewTitle] = useState('')\n  /**\n   * {\n   *  uid: '-1',\n   *   name: 'image.png',\n   *   status: 'done',\n   *   url: 'https://zos.alipayobjects.com/rmsportal/jkjgkEfvpUPVyRjUImniVslZfWPnJuuZ.png',\n   * },\n   */\n  const [fileList, setFileList] = useState<any[]>([])\n\n  useEffect(() => {\n    /**\n     * 初始化渲染时才调用\n     */\n    if (value && !fileList.length) {\n      const fileLinkList = Array.isArray(value) ? value : [value]\n      setFileList(\n        fileLinkList.map((link, index) => {\n          return {\n            uid: mockjs.Random.id(),\n            index: index + 1,\n            name: link.split('/').slice(-1)[0],\n            status: 'done',\n            url: link\n          }\n        })\n      )\n    }\n  }, [value])\n\n  const handleCancel = () => setPreviewOpen(false)\n\n  const handlePreview = async (file: UploadFile) => {\n    if (!file.url && !file.preview) {\n      file.preview = await getBase64(file.originFileObj as RcFile)\n    }\n\n    setPreviewImage(file.url || (file.preview as string))\n    setPreviewOpen(true)\n    setPreviewTitle(file.name || file.url!.substring(file.url!.lastIndexOf('/') + 1))\n  }\n\n  const handleChange = ({ fileList: newFileList }: any) => {\n    setFileList(\n      newFileList.map((file: any, index: number) => {\n        return {\n          ...file,\n          uid: file.uid || mockjs.Random.id(),\n          index: index + 1\n        }\n      })\n    )\n    const emitFileLinks = newFileList.map(\n      (file: any) => file.response?.data || file.url || file.thumbUrl\n    )\n    onChange?.(multiple ? emitFileLinks : emitFileLinks[0] || undefined)\n  }\n\n  const handleInputLink = (e: any) => {\n    setInputLinkOpen(true)\n    e.stopPropagation()\n  }\n\n  const handleInputLinkSave = (link: string) => {\n    handleChange({\n      fileList: [\n        ...fileList,\n        {\n          uid: mockjs.Random.id(),\n          index: fileList.length + 1,\n          name: link.split('/').slice(-1)[0],\n          status: 'done',\n          url: link\n        }\n      ]\n    })\n    setInputLinkOpen(false)\n  }\n\n  const uploadButton = (\n    <div>\n      <PlusOutlined />\n      <div style={{ marginTop: 8 }}>选择图片</div>\n      <div style={{ marginTop: 8 }} onClickCapture={handleInputLink}>\n        输入图片链接\n      </div>\n    </div>\n  )\n\n  const moveRow = useCallbackRef((result: DropResult) => {\n    const { source, destination } = result || {}\n    if (!destination || !source) {\n      return\n    }\n    const sourceIndex = source.index - 1\n    const destinationIndex = destination.index - 1\n    if (sourceIndex === destinationIndex) {\n      return\n    } else {\n      const dragRow = fileList[sourceIndex]\n      fileList.splice(sourceIndex, 1)\n      fileList.splice(destinationIndex, 0, dragRow)\n      setFileList(\n        fileList.map((file, index) => {\n          return {\n            uid: index + 1,\n            ...file\n          }\n        })\n      )\n    }\n  })\n\n  return (\n    <>\n      <DragDropContext onDragEnd={moveRow}>\n        <Droppable droppableId={`droppable-top`} direction=\"horizontal\">\n          {(provided) => (\n            <div\n              id=\"container\"\n              className=\"droppable-wrapper-item\"\n              ref={provided.innerRef}\n              {...provided.droppableProps}\n            >\n              <Upload\n                action={action}\n                multiple={multiple}\n                listType=\"picture-card\"\n                fileList={fileList}\n                onPreview={handlePreview}\n                onChange={handleChange}\n                maxCount={max}\n                itemRender={(originNode, file) => (\n                  <Draggable draggableId={`draggable-${file.uid}`} index={(file as any).index}>\n                    {(_provided) => (\n                      <div\n                        className=\"draggable-wrapper-item\"\n                        ref={_provided.innerRef}\n                        {..._provided.draggableProps}\n                        {..._provided.dragHandleProps}\n                      >\n                        {originNode}\n                      </div>\n                    )}\n                  </Draggable>\n                )}\n              >\n                {fileList.length >= max ? null : uploadButton}\n              </Upload>\n              {provided.placeholder}\n            </div>\n          )}\n        </Droppable>\n      </DragDropContext>\n      <Modal\n        open={previewOpen}\n        visible={previewOpen}\n        title={previewTitle}\n        footer={null}\n        onCancel={handleCancel}\n      >\n        <img alt=\"example\" style={{ width: '100%' }} src={previewImage} />\n      </Modal>\n      <InputLinkModal\n        visible={inputLinkOpen}\n        onClose={() => {\n          setInputLinkOpen(false)\n        }}\n        onSave={handleInputLinkSave}\n      />\n    </>\n  )\n}\n\nconst getBase64 = (file: RcFile): Promise<string> =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.readAsDataURL(file)\n    reader.onload = () => resolve(reader.result as string)\n    reader.onerror = (error) => reject(error)\n  })\n"],"names":["LEGAL_HTTP_SOURCE_REGULAR","InputLinkModal","_ref","visible","onClose","onSave","form","_slicedToArray","Form","useForm","_useState2","useState","imageLink","setImageLink","handleOk","useCallback","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_context","prev","next","validateFields","sent","link","resetFields","stop","React","createElement","Modal","open","title","onOk","onCancel","name","Item","label","rules","required","message","validator","_","value","test","Promise","reject","Error","resolve","validateFirst","Input","allowClear","placeholder","onChange","e","target","Image","height","src","UploadGallery","action","multiple","_ref$max","max","inputLinkOpen","setInputLinkOpen","_useState4","previewOpen","setPreviewOpen","_useState6","previewImage","setPreviewImage","_useState8","previewTitle","setPreviewTitle","_useState10","fileList","setFileList","useEffect","length","fileLinkList","Array","isArray","map","index","uid","mockjs","Random","id","split","slice","status","url","handlePreview","_ref2","file","preview","getBase64","originFileObj","substring","lastIndexOf","_x","apply","this","arguments","handleChange","_ref3","newFileList","_objectSpread","emitFileLinks","_file$response","response","data","thumbUrl","undefined","uploadButton","PlusOutlined","style","marginTop","onClickCapture","stopPropagation","moveRow","useCallbackRef","result","_ref4","source","destination","sourceIndex","destinationIndex","dragRow","splice","Fragment","DragDropContext","onDragEnd","Droppable","droppableId","direction","provided","_extends","className","ref","innerRef","droppableProps","Upload","listType","onPreview","maxCount","itemRender","originNode","Draggable","draggableId","concat","_provided","draggableProps","dragHandleProps","footer","alt","width","_toConsumableArray","reader","FileReader","readAsDataURL","onload","onerror","error"],"mappings":"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"}