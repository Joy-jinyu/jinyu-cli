{"version":3,"file":"index.js","sources":["../src/upload-gallery/input-link-modal.tsx","../src/upload-gallery/index.tsx"],"sourcesContent":["import { Form, Image, Input, Modal } from 'antd'\nimport React, { useState, useCallback } from 'react'\n\ninterface IInputLinkModal {\n  visible: boolean\n  onClose: () => void\n  onSave: (link: string) => void\n}\n\nconst LEGAL_HTTP_SOURCE_REGULAR = /^(?:http(s)?:\\/\\/)(\\S)*(\\.)+/\n\nexport const InputLinkModal = ({ visible, onClose, onSave }: IInputLinkModal) => {\n  const [form] = Form.useForm()\n  const [imageLink, setImageLink] = useState('')\n\n  const imageChange = (e: any) => {\n    setImageLink(e.target.value)\n  }\n\n  const handleOk = useCallback(async () => {\n    const values = await form.validateFields()\n    onSave(values.link)\n    form.resetFields()\n    setImageLink('')\n  }, [])\n\n  const handleCancel = () => {\n    onClose()\n  }\n\n  return (\n    <Modal\n      open={visible}\n      visible={visible}\n      title=\"图片地址\"\n      onOk={handleOk}\n      onCancel={handleCancel}\n    >\n      <Form form={form} name=\"name\">\n        <Form.Item\n          label=\"图片链接\"\n          name=\"link\"\n          rules={[\n            { required: true, message: '请输入图片链接' },\n            () => ({\n              validator(_, value) {\n                if (!!value && !LEGAL_HTTP_SOURCE_REGULAR.test(value as string)) {\n                  return Promise.reject(\n                    new Error('请输入填写正确的地址，例：https://www.baidu.com')\n                  )\n                }\n                return Promise.resolve()\n              }\n            })\n          ]}\n          validateFirst={true}\n        >\n          <Input allowClear placeholder=\"图片链接\" onChange={imageChange} />\n        </Form.Item>\n        {imageLink && LEGAL_HTTP_SOURCE_REGULAR.test(imageLink) && (\n          <Form.Item>\n            <Image height={100} src={imageLink} />\n          </Form.Item>\n        )}\n      </Form>\n    </Modal>\n  )\n}\n","import { PlusOutlined } from '@ant-design/icons'\nimport { Modal, Upload } from 'antd'\nimport type { RcFile } from 'antd/es/upload'\nimport type { UploadFile } from 'antd/es/upload/interface'\nimport mockjs from 'mockjs'\nimport { useCallbackRef } from '@ovometajs/hooks'\nimport React, { useState, useEffect } from 'react'\nimport { DragDropContext, Draggable, Droppable, DropResult } from 'react-beautiful-dnd'\nimport { InputLinkModal } from './input-link-modal'\nimport './styles.less'\n\ninterface IUploadGallery {\n  action: string\n  value?: string\n  onChange?: (value: UploadFile[]) => void\n  multiple?: boolean\n  max?: number\n}\n\nexport const UploadGallery = ({ action, value, onChange, multiple, max = 1 }: IUploadGallery) => {\n  const [inputLinkOpen, setInputLinkOpen] = useState(false)\n  const [previewOpen, setPreviewOpen] = useState(false)\n  const [previewImage, setPreviewImage] = useState('')\n  const [previewTitle, setPreviewTitle] = useState('')\n  /**\n   * {\n   *  uid: '-1',\n   *   name: 'image.png',\n   *   status: 'done',\n   *   url: 'https://zos.alipayobjects.com/rmsportal/jkjgkEfvpUPVyRjUImniVslZfWPnJuuZ.png',\n   * },\n   */\n  const [fileList, setFileList] = useState<any[]>([])\n\n  useEffect(() => {\n    /**\n     * 初始化渲染时才调用\n     */\n    if (value && !fileList.length) {\n      const fileLinkList = Array.isArray(value) ? value : [value]\n      setFileList(\n        fileLinkList.map((link, index) => {\n          return {\n            uid: mockjs.Random.id(),\n            index: index + 1,\n            name: link.split('/').slice(-1)[0],\n            status: 'done',\n            url: link\n          }\n        })\n      )\n    }\n  }, [value])\n\n  const handleCancel = () => setPreviewOpen(false)\n\n  const handlePreview = async (file: UploadFile) => {\n    if (!file.url && !file.preview) {\n      file.preview = await getBase64(file.originFileObj as RcFile)\n    }\n\n    setPreviewImage(file.url || (file.preview as string))\n    setPreviewOpen(true)\n    setPreviewTitle(file.name || file.url!.substring(file.url!.lastIndexOf('/') + 1))\n  }\n\n  const handleChange = ({ fileList: newFileList }: any) => {\n    setFileList(\n      newFileList.map((file: any, index: number) => {\n        return {\n          ...file,\n          uid: file.uid || mockjs.Random.id(),\n          index: index + 1\n        }\n      })\n    )\n    const emitFileLinks = newFileList.map(\n      (file: any) => file.response?.data || file.url || file.thumbUrl\n    )\n    onChange?.(multiple ? emitFileLinks : emitFileLinks[0] || undefined)\n  }\n\n  const handleInputLink = (e: any) => {\n    setInputLinkOpen(true)\n    e.stopPropagation()\n  }\n\n  const handleInputLinkSave = (link: string) => {\n    handleChange({\n      fileList: [\n        ...fileList,\n        {\n          uid: mockjs.Random.id(),\n          index: fileList.length + 1,\n          name: link.split('/').slice(-1)[0],\n          status: 'done',\n          url: link\n        }\n      ]\n    })\n    setInputLinkOpen(false)\n  }\n\n  const uploadButton = (\n    <div>\n      <PlusOutlined />\n      <div style={{ marginTop: 8 }}>选择图片</div>\n      <div style={{ marginTop: 8 }} onClickCapture={handleInputLink}>\n        输入图片链接\n      </div>\n    </div>\n  )\n\n  const moveRow = useCallbackRef((result: DropResult) => {\n    const { source, destination } = result || {}\n    if (!destination || !source) {\n      return\n    }\n    const sourceIndex = source.index - 1\n    const destinationIndex = destination.index - 1\n    if (sourceIndex === destinationIndex) {\n      return\n    } else {\n      const dragRow = fileList[sourceIndex]\n      fileList.splice(sourceIndex, 1)\n      fileList.splice(destinationIndex, 0, dragRow)\n      setFileList(\n        fileList.map((file, index) => {\n          return {\n            uid: index + 1,\n            ...file\n          }\n        })\n      )\n    }\n  })\n\n  return (\n    <>\n      <DragDropContext onDragEnd={moveRow}>\n        <Droppable droppableId={`droppable-top`} direction=\"horizontal\">\n          {(provided) => (\n            <div\n              id=\"container\"\n              className=\"droppable-wrapper-item\"\n              ref={provided.innerRef}\n              {...provided.droppableProps}\n            >\n              <Upload\n                action={action}\n                multiple={multiple}\n                listType=\"picture-card\"\n                fileList={fileList}\n                onPreview={handlePreview}\n                onChange={handleChange}\n                maxCount={max}\n                itemRender={(originNode, file) => (\n                  <Draggable draggableId={`draggable-${file.uid}`} index={(file as any).index}>\n                    {(_provided) => (\n                      <div\n                        className=\"draggable-wrapper-item\"\n                        ref={_provided.innerRef}\n                        {..._provided.draggableProps}\n                        {..._provided.dragHandleProps}\n                      >\n                        {originNode}\n                      </div>\n                    )}\n                  </Draggable>\n                )}\n              >\n                {fileList.length >= max ? null : uploadButton}\n              </Upload>\n              {provided.placeholder}\n            </div>\n          )}\n        </Droppable>\n      </DragDropContext>\n      <Modal\n        open={previewOpen}\n        visible={previewOpen}\n        title={previewTitle}\n        footer={null}\n        onCancel={handleCancel}\n      >\n        <img alt=\"example\" style={{ width: '100%' }} src={previewImage} />\n      </Modal>\n      <InputLinkModal\n        visible={inputLinkOpen}\n        onClose={() => {\n          setInputLinkOpen(false)\n        }}\n        onSave={handleInputLinkSave}\n      />\n    </>\n  )\n}\n\nconst getBase64 = (file: RcFile): Promise<string> =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.readAsDataURL(file)\n    reader.onload = () => resolve(reader.result as string)\n    reader.onerror = (error) => reject(error)\n  })\n"],"names":["LEGAL_HTTP_SOURCE_REGULAR","InputLinkModal","_ref","visible","onClose","onSave","form","_slicedToArray","Form","useForm","_useState2","useState","imageLink","setImageLink","handleOk","useCallback","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_context","prev","next","validateFields","sent","link","resetFields","stop","React","createElement","Modal","open","title","onOk","onCancel","name","Item","label","rules","required","message","validator","_","value","test","Promise","reject","Error","resolve","validateFirst","Input","allowClear","placeholder","onChange","e","target","Image","height","src","getBase64","file","reader","FileReader","readAsDataURL","onload","result","onerror","error","action","multiple","_ref$max","max","inputLinkOpen","setInputLinkOpen","_useState4","previewOpen","setPreviewOpen","_useState6","previewImage","setPreviewImage","_useState8","previewTitle","setPreviewTitle","_useState10","fileList","setFileList","useEffect","length","fileLinkList","Array","isArray","map","index","uid","mockjs","Random","id","split","slice","status","url","handlePreview","_ref2","preview","originFileObj","substring","lastIndexOf","_x","apply","this","arguments","handleChange","_ref3","newFileList","_objectSpread","emitFileLinks","_file$response","response","data","thumbUrl","undefined","uploadButton","PlusOutlined","style","marginTop","onClickCapture","stopPropagation","moveRow","useCallbackRef","_ref4","source","destination","sourceIndex","destinationIndex","dragRow","splice","Fragment","DragDropContext","onDragEnd","Droppable","droppableId","direction","provided","_extends","className","ref","innerRef","droppableProps","Upload","listType","onPreview","maxCount","itemRender","originNode","Draggable","draggableId","concat","_provided","draggableProps","dragHandleProps","footer","alt","width","_toConsumableArray"],"mappings":"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"}